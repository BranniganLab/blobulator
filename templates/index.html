<!--This is the html script for the output page of the tool. This is implemented using the bootstrap library for layout purposes. Bootstrap utilizes rows and columns for spacial organization. The visualizations are written using the d3 library package. The contents of the page from top to bottoms are:
1) Header that contains title, protein name, uniprot ID, and Gene
2) Sliders: 
  a) Hydropathy cutoff slider with textbox entry underneath that responds to the slider 
  and the visualizations
  b) Minimum blob size slider that responds to the visualizations
3) Mean Hydropathy plot. Blue line adjusts the cutoff on this plot via the hydropathy cutoff slider.
Default is 0.4. To the right is a tool tip that explains the plot when the user hovers over it
4) Blobulation visualization with the Das & Pappu color schena. Tooltip and color key is provided.
5) Blobulation visualization with NCPR color gradient. Tooltip and color bar is provided 
(color bar is just a jpg image)
6) Order and disorder plots (not related to blobulation plots)

4-6 contains SNPs mapped along the sequence from the ClinVar database. User can hover over the SNP,
the SNP will turn red and if the user chooses to click on the SNP the ClinVar data will be open in a new tab 

-->
<html>

<head>
    <!--The blobulation annotations are generated using the D3 visualization library-->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script type="text/javascript"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>{{ protein_name }} </title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</head>


<body>
    <div class="container">
    <!--Header that contains Title, protein name, Uni ID, and Gene. 
  Other information can be placed here too? -->
    <div class="text-center">
        <h1> The Protein Blobulator </h1>
        <h6> Uniprot ID: {{ my_uni_id | safe }}</h6>
    </div>
    <!--The div id my_dataviz is the div container for ALL D3 visualization plots, color keys-->
    <div id="my_dataviz" class="viz_track">
        <!--This section contains the div containers for the sliders and the text entry box-->
        <div class="text-left">
            Hydropathy cutoff:
            <label style = "opacity: 0.0; display: none;">
             <span id="cutoff_user"></span>
            </label>
            <input type="number" id="cutoff_user_box" min="0" max="1.0" value={{ my_cut | safe }} step=0.001>
            
            <input type="range" name="mySlider" id="cutoff_user_slider" min="0" max="1.0" value={{ my_cut | safe }} class="myslider1" step=0.001>

            
        </div>
        <div class="text-left">
            Minimum blob size:
            <label style = "opacity: 0.0; display: none;"> <span id="domain_threshold_user"></span>
            </label>
            <input type="number" id="domain_threshold_user_box" min="1" max={{ domain_threshold_max | safe }} value={{ domain_threshold | safe }}   step=1>
            <input type="range" name="mySlider" id="domain_threshold_user_slider" min="1" max={{ domain_threshold_max | safe }} value={{ domain_threshold | safe }} class="myslider2" step=1>
        </div>

        <div>
            <input type="checkbox" class="checkbox" id="mutatebox" value="True"> <label for="mutatebox">Mutate residue</label>
            <!-- my_seq includes single quotes in the string so we have to do this subscripting here -->
            <select id="snp_id">
            {% for residue in my_seq[1:-1] %}
            <option value="{{ loop.index0 + 1 }}"> {{ loop.index0 + 1 }} ({{ residue }})</option>
            {% endfor %}
            </select>
            to
            <select id="residue_type">
             <option value="A">A</option>
             <option value="R">R</option>
             <option value="N">N</option>
             <option value="D">D</option>
             <option value="C">C</option>
             <option value="Q">Q</option>
             <option value="E">E</option>
             <option value="G">G</option>
             <option value="H">H</option>
             <option value="I">I</option>
             <option value="L">L</option>
             <option value="K">K</option>
             <option value="M">M</option>
             <option value="F">F</option>
             <option value="P">P</option>
             <option value="S">S</option>
             <option value="T">T</option>
             <option value="W">W</option>
             <option value="Y">Y</option>
             <option value="V">V</option>                
            </select>
        </div>




        <div class="text-left">
        <label style = "opacity: 0.0; display: none; position: relative;"> </label>
        <button type="button" id="download_plot_link">Download plots!</button>
        <button type="button" id="download_data_link">Download data!</button>
        </div>
    </div>
      

</div>
</body>
<style>
/*CSS styling for the blue i tooltip */
.header {
  line-height: 2rem;
  outline: 1px solid red;
  background: #fff;
  padding: 1rem;

  position: sticky;
  top: 0;
}

.tooltip {
    position: absolute;
    text-align: center;
    width: 100px;
    height: 20px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0px;
}

.rangeslider {
    width: 90%;
    padding: 10px;
}

/*CSS styling for the top slider*/
.myslider1 {
    -webkit-appearance: none;
    /* Override default CSS styles */
    appearance: none;
    width: 30%;
    /* Full-width */
    height: 20px;
    /* Specified height */
    background: #d3d3d3;
    /* Grey background */
    outline: none;
    /* Remove outline */
    opacity: 0.7;
    /* Set transparency (for mouse-over effects on hover) */
    -webkit-transition: .2s;
    /* 0.2 seconds transition on hover */
    transition: opacity .2s;

}

/*CSS styling for the top slider button*/
.myslider1::-webkit-slider-thumb {
    -webkit-appearance: none;
    cursor: pointer;
    background: #007BFF;
    border-radius: 20px;
    width: 20px;
    height: 20px;
}

.myslider1:hover {
    opacity: 2.0;
}

/*CSS styling for the bottom slider*/
.myslider2 {
    -webkit-appearance: none;
    /* Override default CSS styles */
    appearance: none;
    width: 30%;
    /* Full-width */
    height: 20px;
    /* Specified height */
    background: #d3d3d3;
    /* Grey background */
    outline: none;
    /* Remove outline */
    opacity: 0.7;
    /* Set transparency (for mouse-over effects on hover) */
    -webkit-transition: .2s;
    /* 0.2 seconds transition on hover */
    transition: opacity .2s;

}


/*CSS styling for the bottom slider button*/
.myslider2::-webkit-slider-thumb {
    -webkit-appearance: none;
    cursor: pointer;
    background: #007BFF;
    border-radius: 20px;
    width: 20px;
    height: 20px;
}

.myslider2:hover {
    opacity: 2.0;
}
</style>
<script>

//--------------Javascrpt for plotting in d3-------------
//tooltip for SNPs link
var Tooltip_snps = d3.select("body")
    .append("div") // declare the tooltip div 
    .attr("class", "tooltip")
    .style("opacity", 0);

//tooltip for plots inforamtion panel
var Tooltip = d3.select("body")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "5px")
    .style("padding", "5px")
    .style("padding", "5px")
    .style("width", "400px")
    .style("height", "610px")
    .style("font-size", "18px")
    .style("text-align", "justify")

//updates the slider/box value entered by the user
var cutoff_slider = document.getElementById("cutoff_user_slider");
var cutoff_slider_value = document.getElementById("cutoff_user");
var cutoff_box = document.getElementById("cutoff_user_box");
cutoff_slider_value.innerHTML = cutoff_slider.value;


cutoff_slider.oninput = function() {
    cutoff_box.value = this.value;
    cutoff_slider_value.innerHTML = this.value;

}

cutoff_box.oninput = function() {
    cutoff_slider.value = this.value;
    cutoff_slider_value.innerHTML = this.value;
}


var domain_threshold_slider = document.getElementById("domain_threshold_user_slider");
var domain_threshold_value = document.getElementById("domain_threshold_user");
var domain_threshold_box = document.getElementById("domain_threshold_user_box");
domain_threshold_value.innerHTML = domain_threshold_slider.value;

domain_threshold_slider.oninput = function() {
    domain_threshold_box.value = this.value;
    domain_threshold_value.innerHTML = this.value;
}

domain_threshold_box.oninput = function() {
    domain_threshold_slider.value = this.value;
    domain_threshold_value.innerHTML = this.value;
}

//These variables set fixed values for height and width to be used in making all four visualizations 
var margin = { top: 30, right: 230, bottom: 30, left: 50 },
    width = 1200 - margin.left - margin.right,
    height = 200 - margin.top - margin.bottom;


//--------------------------------------------//make svg containers for each plot------------------------------------//
function chart(chartID, title) {
    

    //Sets the dimensions and location of the svg container Smoothed hydropathy per residue contents
    var svg = d3.select("#my_dataviz")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    //Creates the title
    svg.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top - 25)
        .style("text-anchor", "middle")
        .text(title)
        .attr("font-size", "20px")

    //Creates the "Residue" x-axis label for Smoothed hydropathy per residue
    svg.append("text")
        .attr("x", width / 2)
        .attr("y", height + margin.bottom)
        .style("text-anchor", "middle")
        .text("Residue")


    if (chartID == "plot2" || chartID == "plot3"|| chartID == "plot4" || chartID == "plot5") {
        //Creates the "Mean Hydropathy" y-axis label for Smoothed hydropathy per residue
        //"p" blob y-axis label for globular tendency plot
        svg.append("text")
            .attr("class", "y label")
            .attr("text-anchor", "middle")
            .attr("x", 0 - (height / 2) - 50)
            .attr("y", margin.left - 80)
            .attr("transform", "rotate(-90)")
            .text("p");

        //"h" blob y-axis label for globular tendency plot
        svg.append("text")
            .attr("class", "y label")
            .attr("text-anchor", "middle")
            .attr("x", 0 - (height / 2))
            .attr("y", margin.left - 80)
            .attr("transform", "rotate(-90)")
            .text("h");

        //"SNPs" y-axis label for globular tendency plot
        svg.append("text")
            .attr("class", "y label")
            .attr("text-anchor", "middle")
            .attr("x", 0 - (height / 2) + 40)
            .attr("y", margin.left - 80)
            .attr("transform", "rotate(-90)")
            .text("SNPs");

        if (chartID == "plot2") {
            //This section contains the key that appears next to the Globular tendency colored plot
            //Circles for the key
            svg.append("circle").attr("cx", width + 30).attr("cy", margin.top - 15).attr("r", 10).style("fill", "#0f0")
            svg.append("circle").attr("cx", width + 30).attr("cy", margin.top + 15).attr("r", 10).style("fill", "#FEE882")
            svg.append("circle").attr("cx", width + 30).attr("cy", margin.top + 45).attr("r", 10).style("fill", "#BF72D2")
            svg.append("circle").attr("cx", width + 30).attr("cy", margin.top + 75).attr("r", 10).style("fill", "#f00")
            svg.append("circle").attr("cx", width + 30).attr("cy", margin.top + 105).attr("r", 10).style("fill", "#00f")
            //Text that appears to the right of the circles in the key    
            svg.append("text").attr("x", width + 50).attr("y", margin.top - 15).text("1: Globular").style("font-size", "15px").attr("alignment-baseline", "middle")
            svg.append("text").attr("x", width + 50).attr("y", margin.top + 15).text("2: Janus/Boundary").style("font-size", "15px").attr("alignment-baseline", "middle")
            svg.append("text").attr("x", width + 50).attr("y", margin.top + 45).text("3: Strong Polyelectrolyte").style("font-size", "15px").attr("alignment-baseline", "middle")
            svg.append("text").attr("x", width + 50).attr("y", margin.top + 75).text("4: Negatively charged strong polyelectrolyte").style("font-size", "15px").attr("alignment-baseline", "middle")
            svg.append("text").attr("x", width + 50).attr("y", margin.top + 105).text("5: Positively charged strong polyelectrolyte").style("font-size", "15px").attr("alignment-baseline", "middle")

            //Blue i tool tip to the right of globular tendency plot
            svg.append("text").attr("x", width - 3).attr("y", margin.top - 28).text("i").style("font-size", "20px").style("font-weight", "bold").style("font-family", "zapfino").style("fill", "1E59FC").attr("alignment-baseline", "middle").attr("class", "info-hover")

                .on("mouseover", function(d) {
                    d3.select(this)
                    //.style("fill", "black");
                    Tooltip.transition()
                        .duration(100)
                        .style("opacity", 1);
                    Tooltip.html(
                        "<p>The Das-Pappu phase diagram provides a means to estimate how a disordered sequence might behave based on the charge content. Each blob is colored according to the region they fall in Das-Pappu phase diagram. </p> <img src=\"/static/daspappu_graph.png\" width=\"200\" height=\"200\"> <p> <i> <b> The original figure can be found in the article: </b> Das RK, Papu RV (2013) Conformations of intrinsically disordered proteins are influenced by linear sequence distributions of oppositely charged residues PNAS 110(33):13392–13397.</i> <b> This figure was developed for: </b> Lohia R, Salari R, Brannigan G (2019) Sequence specificity despite intrinsic disorder: How a disease-associated Val/Met polymorphism rearranges tertiary interactions in a long disordered protein. PLoS Comput Biol 15(10): e1007390. https://doi.org/10.1371/journal.pcbi.1007390. </p>")

                        .style("left", (d3.mouse(this)[0] + 70) + "px")
                        .style("top", (d3.mouse(this)[1] + (margin.top) + 500) + "px");
                })
                .on("mouseout", function(d, i) {
                    d3.select(this)
                    Tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                })
        } else if (chartID == "plot4") {
            var colorbar = svg.append('image')
                .attr('xlink:href', '/static/disorder_key1.png')
                .attr('width', 51)
                .attr('height', 107)
                .attr("x", width + 30)
                .attr("y", margin.top + 15)


            //Blue i tool tip to the right of the NCPR plot
            svg.append("text").attr("x", width - 3).attr("y", margin.top - 28).text("i").style("font-size", "20px").style("font-weight", "bold").style("font-family", "zapfino").style("fill", "1E59FC").attr("alignment-baseline", "middle").attr("class", "info-hover")
                .on("mouseover", function(d) {
                    d3.select(this)
                    //.style("fill", "black");
                    Tooltip.transition()
                        .duration(100)
                        .style("opacity", 1);
                    Tooltip.html(
                            "<p>For each blob its fraction of disorderd residue is calculated.</p>")
                        .style("left", (d3.mouse(this)[0] + 70) + "px")
                        .style("top", (d3.mouse(this)[1] + (margin.top) + 700) + "px");
                })
                .on("mouseout", function(d, i) {
                    d3.select(this)
                    Tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                })
        } else if (chartID == "plot5") {
            var colorbar = svg.append('image')
                .attr('xlink:href', '/static/uv_disorder_key.png')
                .attr('width', 51)
                .attr('height', 107)
                .attr("x", width + 30)
                .attr("y", margin.top + 15)


            //Blue i tool tip to the right of the NCPR plot
            svg.append("text").attr("x", width - 3).attr("y", margin.top - 28).text("i").style("font-size", "20px").style("font-weight", "bold").style("font-family", "zapfino").style("fill", "1E59FC").attr("alignment-baseline", "middle").attr("class", "info-hover")
                .on("mouseover", function(d) {
                    d3.select(this)
                    //.style("fill", "black");
                    Tooltip.transition()
                        .duration(100)
                        .style("opacity", 1);
                    Tooltip.html(
                            "<p>For each blob its distance from the uversky diagram slope is plotted. Postive values are disordered and negative values are ordered. </p>")
                        .style("left", (d3.mouse(this)[0] + 70) + "px")
                        .style("top", (d3.mouse(this)[1] + (margin.top) + 700) + "px");
                })
                .on("mouseout", function(d, i) {
                    d3.select(this)
                    Tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                })
        } else {
            //Color bar key to the right of the NCPR plot. It appends a png image.
            var colorbar = svg.append('image')
                .attr('xlink:href', '/static/gradient_key.png')
                .attr('width', 51)
                .attr('height', 107)
                .attr("x", width + 30)
                .attr("y", margin.top + 15)


            //Blue i tool tip to the right of the NCPR plot
            svg.append("text").attr("x", width - 3).attr("y", margin.top - 28).text("i").style("font-size", "20px").style("font-weight", "bold").style("font-family", "zapfino").style("fill", "1E59FC").attr("alignment-baseline", "middle").attr("class", "info-hover")
                .on("mouseover", function(d) {
                    d3.select(this)
                    //.style("fill", "black");
                    Tooltip.transition()
                        .duration(100)
                        .style("opacity", 1);
                    Tooltip.html(
                            "<p>For each blob its net charge per residue (NCPR) is calculated. </p>")
                        .style("left", (d3.mouse(this)[0] + 70) + "px")
                        .style("top", (d3.mouse(this)[1] + (margin.top) + 700) + "px");
                })
                .on("mouseout", function(d, i) {
                    d3.select(this)
                    Tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                })

        }
    } else {

        //Creates the "Mean Hydropathy" y-axis label for Smoothed hydropathy per residue
        svg.append("text")
            .attr("class", "y label")
            .attr("text-anchor", "middle")
            .attr("x", 0 - (height / 2))
            .attr("y", margin.left - 80)
            .attr("transform", "rotate(-90)")
            .text("Mean Hydropathy");
        //Adding the information tooltip
        svg.append("text").attr("x", width - 3).attr("y", margin.top - 28).text("i").style("font-size", "20px").style("font-weight", "bold").style("font-family", "zapfino").style("fill", "1E59FC").attr("alignment-baseline", "middle").attr("class", "info-hover")
            .on("mouseover", function(d) {
                d3.select(this)
                //.style("fill", "black");
                Tooltip.transition()
                    .duration(100)
                    .style("opacity", 1);
                Tooltip.html(
                        "<p>The linear hydropathy uses a sliding, overlapping window approach to calculate the mean hydropathy for groups of 3 residues. This value is rescaled to lie between 0 (hydrophilic) and 1 (hydrophobic). This plot can help you identify how hydrophobicity varies along your sequence.</p>" +
                        "<p>Any stretch of 'minimum blob size' or more residues with mean hydropathy > 'hydropathy cutoff' is classified as a hydrophobic or “h” blob and any remaining stretch of four or more residues is classified as a non-hydrophobic linker or “p” blob.</p>")
                    .style("left", (d3.mouse(this)[0] + 70) + "px")
                    .style("top", (d3.mouse(this)[1] + (margin.top) + 200) + "px");
            })
            .on("mouseout", function(d, i) {
                d3.select(this)
                Tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            })

    }

    return svg
}

//reads the input variable from flask

var uni_id = {{ my_uni_id | safe }}
var uni_id_str = '["' + uni_id + '"]'
var my_seq = {{ my_seq | safe }}
var my_data = {{ data.chart_data | safe }}
console.log(my_seq)


var my_cut = {{ my_cut | safe }}
var my_snp = {{ my_snp | safe }}
var my_disorder = {{ my_disorder | tojson| safe }}
var domain_threshold_max = {{ domain_threshold_max | safe }}

console.log("my_disorder")
console.log(my_disorder)
//makes the plots
//--------------------------------------------------------------------adding bar graphs to SVGs------------------------------------------//
draw(my_data)

function draw(data) {


    var svg1 = chart("plot1", "Smoothed hydropathy per residue")
    var svg2 = chart("plot2", "Blobs colored according to globular tendency")
    var svg3 = chart("plot3", "Blobs colored according to net charge per residue")
    var svg5 = chart("plot5", "Blobs colored according to uversky diagram")

    if (my_disorder == "0") {
        var plot_list = [svg1, svg2, svg3, svg5]
        console.log("my_disorder2")
        console.log(my_disorder)


    } else {
        var svg4 = chart("plot4", "Blobs colored according to fraction of disordered residue")
        var plot_list = [svg1, svg2, svg3, svg4, svg5] 

    }
    var domain_bar, domain_bar_disorder,domain_bar_ncpr, domain_bar_u;

    var plot_variable = {2: domain_bar, 3: domain_bar_ncpr, 4: domain_bar_disorder, 5: domain_bar_u };


    var tem = plot_variable[2]


    data.forEach(function(d) {
            d.resid = +d.resid;
            d.hydropathy = +d.hydropathy;
            d.N = +d.N;
            d.hydropathy_3_window_mean = +d.hydropathy_3_window_mean;
            d.domain_to_numbers = +d.domain_to_numbers
            d.m_cutoff = +d.m_cutoff
            d.domain_threshold = +d.domain_threshold

    });


    for (let [index, svg] of plot_list.entries()) {
        if  (svg==svg2) {
            data.forEach(function(d) {
            d.var = d.P_diagram
        })
        } else if (svg==svg3) {
            data.forEach(function(d) {
            d.var = d.NCPR_color
        })
        } else if  (svg==svg4) {
            data.forEach(function(d) {
            d.var = d.disorder_color
        })
        } else {
            data.forEach(function(d) {
            d.var = d.uversky_color
        })
        }

        var y = d3.scaleLinear()
            .domain([0, 1])
            .range([height, 0]);

        // add the x Axis
        var x = d3.scaleBand()
            .range([0, width])
            //    .domain([1,data.length])
            .domain(data.map(function(d) { return d.resid; }))
            .padding(0.2);
        var xAxis = svg.append("g")
            .call(d3.axisBottom(x).tickValues(x.domain().filter(function(d, i) { return !((i+1) % 
               (Math.round((Math.round(domain_threshold_max/10))/10)*10) )})))
            .attr("transform", "translate(0," + height + ")");
        // Bars

        if (svg == svg1) {

            svg.append("g") //the y axis is drawn only for plot 1
                .call(d3.axisLeft(y));

            var cut_line = svg.append('g')
                .append("path")
                .attr("class", "mypath")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                    .x(function(d) { return x(d.resid) })
                    .y(function(d) { return y(my_cut) })
                );

            var hydropathy_bar = svg.selectAll("mybar")
                .data(data)
                .enter()
                .append("rect")
                .attr("x", function(d) { return x(d.resid); })
                .attr("y", function(d) { return y(d.hydropathy_3_window_mean); })
                .attr("width", x.bandwidth())
                .attr("height", function(d) { return height - y(d.hydropathy_3_window_mean); })
                .attr("fill", 'grey')
                .on("mouseover", function() {
                    d3.select(this)
                        .attr("fill", "grey");
                })
                .on("mouseout", function(d, i) {
                    d3.select(this).attr("fill", function() {
                        return "" + 'grey' + "";
                    });
                });

        } else {

            plot_variable[index] = svg.selectAll("rect")
                .data(data)
                .enter()
                .append("rect")
                .attr("x", function(d) { return x(d.resid); })
                .attr("y", function(d) { return y(d.domain_to_numbers); })
                .attr("width", x.bandwidth())
                .attr("height", function(d) { return height - y(d.domain_to_numbers); })
                .attr("fill", function(d) { return d.var; })

        }
        
        //add snp tool tips
        if (svg != svg1) {
            svg.append('g')
                .selectAll("rect")
                //.data(my_disorder.map(function(d) { return +d; }))
                .data(my_snp)
                .enter()
                .append("rect")
                .attr("x", function(d) { return x((d.resid)); })
                .attr("y", function(d) { return y(0.8); })
                .attr("width", x.bandwidth())
                .attr("height", function(d) { return y(0.8); })
                .attr("fill", 'black')
                .on("click", function(d) {
                    //window.location.href = d.xrefs[0].url+'_blank'
                    window.open(d.xrefs.url, '_blank')
                })
                .on("mouseover", function(d) {
                    d3.select(this)
                        .attr("fill", "red");
                    Tooltip_snps.transition()
                        .duration(100)
                        .style("opacity", .9);
                    Tooltip_snps.html(
                            '<a href="' + d.xrefs.url + '"target="_blank">' + d.xrefs.id +
                            "</a>")
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function(d, i) {
                    d3.select(this).attr("fill", function() {
                        return "" + 'black' + "";
                    })
                    Tooltip_snps.transition()
                        .duration(500)
                        .style("opacity", 0);
                })

        }
    }
    var str = "Download plots!";
    var str_j = "Download data!";

    //------------------------------------------A function that update the chart when eitgher slider is moved-----------------------------------------------//
    function updateChart(given_cutoff, data_updated) {

        cut_line
            .transition()
            .duration(1000)
            .attr("d", d3.line()
                .x(function(d) { return x(d.resid); })
                .y(function(d) { return y(given_cutoff); })
            );


        for (let [index, svg] of plot_list.entries() ) {
            if  (svg==svg2) {
                data_updated.forEach(function(d) {
                d.var = d.P_diagram
            })
            } else if (svg==svg3) {
                data_updated.forEach(function(d) {
                d.var = d.NCPR_color
            })
            } else if  (svg==svg4) {
                data_updated.forEach(function(d) {
                d.var = d.disorder_color
            })
            } else {
                data_updated.forEach(function(d) {
                d.var = d.uversky_color
            })
            }

            if (svg!=svg1) {
                svg.selectAll("rect")
                    .data(data_updated)
                plot_variable[index]
                    .enter()
                    .append("rect")
                    .merge(plot_variable[index])
                    .transition()
                    .duration(1000)
                    .attr("x", function(d) { return x(d.resid); })
                    .attr("y", function(d) { return y(d.domain_to_numbers); })
                    .attr("width", x.bandwidth())
                    .attr("height", function(d) { return height - y(d.domain_to_numbers); })
                    .attr("fill", function(d) { return d.var })
                
           } else {

           }

           }
        }

    // Update the output when parameters are changed
    function do_update() {
        // If the box is check, I mutate the amino acid
        if(d3.select("#mutatebox").property("checked")){
            
            var snp_id = document.getElementById("snp_id").value;
            var my_seq = {{ my_seq | safe }};
            var amino_acid = document.getElementById("residue_type").value;
            var my_seq =  my_seq.slice(0, snp_id-1) + amino_acid + my_seq.substr(snp_id, my_seq.length);

        // Otherwise I revert back to wild sequence initially uploaded
        } else {
            var my_seq = {{ my_seq | safe }};
        }

        var d_value = d3.select("#domain_threshold_user").text()
        var selectedValue = d3.select("#cutoff_user").text()
        var m_str = {my_seq: my_seq, domain_threshold: d_value, cutoff: selectedValue, my_disorder:my_disorder}

        $.post( "/postmethod", m_str , "json")
        .then(function(data) {
            var data_tmp = data.chart_data;
            var tt = JSON.stringify(eval("(" + data_tmp + ")"));
            var data_obj = JSON.parse(tt);
            updateChart(selectedValue, data_obj);
        });
    }
    
    // Set up UI element change handlers
    d3.selectAll(".checkbox").on("change", do_update)
    d3.select("#cutoff_user_slider").on("change", do_update);
    d3.select("#cutoff_user_box").on("change", do_update);
    d3.select("#domain_threshold_user_slider").on("change", do_update);
    d3.select("#domain_threshold_user_box").on("change", do_update);
    d3.selectAll("#mutatebox,#snp_id,#residue_type").on("change", do_update);

    //download_data
    d3.select('#download_data_link').on('click', function(){
        // If the box is check, I mutate the amino acid
        // TODO: This code should not be duplicated
        var my_seq = {{ my_seq | safe }};
        if(d3.select("#mutatebox").property("checked")){
            var snp_id = document.getElementById("snp_id").value;
            var amino_acid = document.getElementById("residue_type").value;
            my_seq =  my_seq.slice(0, snp_id-1) + amino_acid + my_seq.substr(snp_id, my_seq.length);
        }

        $.ajax({
                url: "/json",
                type: "post",
                data: {my_seq: my_seq, domain_threshold: d3.select("#domain_threshold_user").text(), cutoff: d3.select("#cutoff_user").text(), my_disorder:my_disorder},
                xhrFields: {
                responseType: 'blob'
                },
                success: function(data) {console.log(data)
                var a = document.createElement('a');
                var url = window.URL.createObjectURL(data);
                a.href = url;
                a.download = 'myfile.csv';
                document.body.append(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                }
            });
        })  

    //download_plots
    $('#download_plot_link').click(function() {
        window.location='/plot?' + 'domain_threshold=' + d3.select("#domain_threshold_user").text() + '&cutoff=' + d3.select("#cutoff_user").text()    

        })

};

</script>
<br>
<br>
<br>
<br>
<!--footer for the page-->
<footer>
    <div class="container">

        <p>Protein Blobulator - &copy; Brannigan Lab 2021</p>
    </div>
</footer>

</html>
​